<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="stylesheet.css" />
    <title>Banned Books</title>
</head>
<!-- used Color Brewer and Viz Pallette for chart colors -->
<body>
    <div class="container">
        <div class="heading"> 
            <h1 class="heading-text">5,813 books were challenged in the US in 2024</h1>
    
        </div>
        <div class="text-container">
             <p class="section-text">
                Over the last 5 years, book bans have become more prevalent in the United States. 
                After the COVID-19 pandemic and election of former president Biden, there was a drastic 
                increase in the numbers of books banned and challenged yearly in the US.
             </p>
        </div>
        <div class="chart-container">
            <h2 class="chart-title">Books Challenged in the Last 10 Years</h2>
            <div style="min-height:425px" id="datawrapper-vis-ULINl"><script type="text/javascript" defer src="https://datawrapper.dwcdn.net/ULINl/embed.js" charset="utf-8" data-target="#datawrapper-vis-ULINl"></script><noscript><img src="https://datawrapper.dwcdn.net/ULINl/full.png" alt="" /></noscript></div>
            <div id="datawrapper"></div>
        </div>
        <div class="text-container">
            <p class="section-text">
                Between 2015 and 2020 the number of titles challenged stayed relatively steady, 
                fluctuating between 230 and 332. But then, in 2021, the number of titles challenged 
                jumped to 3,926. This was a 1317% increase from the number of titles challenged in 2020. 
                The continued to rise and have not returned to previous levels. These numbers may seem 
                alarming but abstract, so what does this mean?
             </p>
        </div>
        <div class="context">
            <h2 class="context-title">What is a book ban?</h2>
            <p class="context-text">
                A book ban is a form of censorship. Bans aim to restrict access to books that 
                some deem inappropriate or otherwise unsuitable for audiences.
            </p>
            <h3 class="follow-up-title">What is the difference between a ban and a challenge?</h3>
            <p class="context-text">
                PEN America defines a challenge as “any attempt to restrict or remove a book based on 
                objections to its content.” A ban, however, is the actual restriction of a challenged book.
            </p>
        </div>
        <div class="text-container">
            <h2 class="section-title">So, what's happening?</h2>
            <p class="section-text">
                The influx of book challenges has lead to the removal and restriction of thousands of 
                books from various public and private spaces. In 2024 an overwhelming majority of books were 
                restricted in libraries.
             </p>
        </div>
        <div class="chart-container">
            <h2 class="chart-title">Public Libraries Face The Most Censorship</h2>
            <div id="donut-chart"></div>
        </div>
        <div class="text-container">
            <p class="section-text">
                Libraries make up 93% of the places books were banned last year. Libraries are important
                 because they give people free access to information and resources. Not only are school libraries 
                 being targeted by these bans, restricting access to books from students, but public libraries are 
                 the most censored. 55% of the books banned in 2024 were banned in public libraries. The 
                 consequence of this is that the general public is being denied access to diverse information 
                 unless they can find somewhere to buy it. <strong>WRITE ABOUT WHICH STATES</strong>
             </p>
        </div>
        <div class="chart-container">
            <h2 class="chart-title">Number of Challenges in Each State 2023-2024 School Year</h2>
            <div id="cartogram-chart"></div>
        </div>
        <div class="text-container">
            <p class="section-text">
                segway So, who is causing this?
             </p>
             <!-- <a href = "/packing.html">circle packing</a>
             <a href = "/cartogram.html">cartogram</a> -->
             <!-- <a href = "/pcoord.html">parallel coordinates</a> -->
        </div>
        <div class="chart-container">
            <h2 class="chart-title">School Administrations Are Responsible For Over 1/3 of Challenges</h2>
            <div id="donut-chart2"></div>
        </div>
        <div class="text-container">
            <p class="section-text">
                Despite libraries being the primary target of these bans, librarians, teachers, and staff 
                only make up 1% of the people challenging books. 46% of these people are goverment officials 
                or board members, they are responsible for not only for challenging books but they also have 
                to power to ban them. The next largest group is parents and pressure groups, making up 42% of 
                advocates for banning books. Many of these pressure groups are conservative communities, one 
                example being parents rights groups. As the name suggests, pressure groups pressure organizations 
                (schools, libraries, etc) to restrict access to books they think are inappropriate for public spaces.
                What are they censoring? 
             </p>
        </div>
        <!-- <div class="chart-container">
            <h2 class="chart-title">Themes of Books Banned in 2022-2023</h2>
            <div id="bar-chart"></div>
        </div> -->
        <div class="chart-container">
            <h2 class="chart-title">Themes of Books Banned in 2022-2023</h2>
            <div id="treemap"></div>
        </div>
        <div class="text-container">
            <p class="section-text">
                words 
             </p>
        </div>
        <div class="chart-container" style="height: 700px;">
            <div class="tab">
                <button class="tablinks" onclick="openTheme(event, 'Overview')" id="defaultOpen">Overview</button>
                <button class="tablinks" onclick="openTheme(event, 'Sexual')">Sexual Content & Profanity</button>
                <button class="tablinks" onclick="openTheme(event, 'Violence')">Violence & Abuse</button>
                <button class="tablinks" onclick="openTheme(event, 'Race')">Race/Racism</button>
                <button class="tablinks" onclick="openTheme(event, 'Sexuality')">Sexuality/Gender</button>
                <button class="tablinks" onclick="openTheme(event, 'Death')">Death & Illness</button>
                <button class="tablinks" onclick="openTheme(event, 'Drugs')">Drugs & Alcohol</button>
                <button class="tablinks" onclick="openTheme(event, 'Religion')">Religion & Politics</button>
                <button class="tablinks" onclick="openTheme(event, 'Explain')">More Information</button>
              </div>
              
              <div id="Overview" class="tabcontent">
                  <h2 class="chart-title">Top 144 Books Banned in the US from July 1, 2023 to June 30, 2024</h2>
                  <div id="scatterplot"></div>
              </div>
              
              <div id="Sexual" class="tabcontent">
                  <h2 class="chart-title">Banned because of Sexual Content & Profanity</h2>
                  <div id="scatterplot-mature"></div>
              </div>
              
              <div id="Violence" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Violence & Abuse</h2>
                  <div id="scatterplot-violence"></div>
              </div>
              
              <div id="Race" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Race/Racism</h2>
                  <div id="scatterplot-race"></div>
              </div>
              
              <div id="Sexuality" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Sexuality/Gender</h2>
                  <div id="scatterplot-sexuality"></div>
              </div>
              
              <div id="Death" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Death & Illness</h2>
                  <div id="scatterplot-death"></div>
              </div>
              
              <div id="Drugs" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Drugs & Alcohol</h2>
                  <div id="scatterplot-drugs"></div>
              </div>
              
              <div id="Religion" class="tabcontent">
                  <h2 class="chart-title">Banned because of themes of Religion & Politics</h2>
                  <div id="scatterplot-religion"></div>
              </div>

              <div id="Explain" class="tabcontent">
                <h2 class="chart-title">What Is Included In Each Theme?</h2>
                <p style = "font-size: 14pt; line-height: 1.3;">
                    <strong>Sexual Content & Profanity:</strong> Depictions of sex, swearing, or other content that was deemed mature.<br/><br/>
                    <strong>Violence & Abuse:</strong> Depictions or discussion of sexual violence/assault, child abuse, domestic abuse, other kinds of abuse, police violence, school shootings, murder, graphic fights, and other physical violence.<br/><br/>
                    <strong>Race/Racism:</strong> Depictions or acknowledgment of racism, slavery, and other content painted as Critical Race Theory.<br/><br/>
                    <strong>Sexuality/Gender:</strong> Depictions of queer relationships, queer and/or trans experiences, inclusion of LGBTQIA+ characters, inclusion of ideas that go against traditional gender ideology (ex. feminist or trans ideas), misogyny, sexism.<br/><br/>
                    <strong>Death & Illness:</strong> Depictions of death, mental illness, suicide, mental health, terminal illness, and/or disabilities.<br/><br/>
                    <strong>Drugs & Alcohol:</strong> Depictions of drug and/or alcohol use as well as alcoholism and other addiction.<br/><br/>
                    <strong>Religion & Politics:</strong> Religious or anti-religious themes, depictions of war, communist ideology, and inclusions of abortion or birth control.<br/><br/>

                </p>
            </div>
        </div>
        <div class="text-container">
            <a href="alarktabs.html">
                <h2>Tabs on different html pages</h2>
              </a>
            <p class="section-text">
                words 
             </p>
        </div>
        <div class="context">
            <h2 class="context-title">Why Should You Care?</h2>
            <p class="context-text">
                explanation
            </p>
        </div>
        <div class="text-container">
            <h2 class="section-title">Resources</h2>
            <p class="section-text">
                W3Schools<br/>
                D3 Gallery<br/>
                Alark Joshi<br/>
                ColorBrewer<br/>
                Viz Palette<br/>
                Data Wrapper<br/>
                https://www.ala.org/bbooks/book-ban-data <br/>
                https://www.ala.org/bbooks/censorship-numbers <br/>
                https://pen.org/book-bans-frequently-asked-questions/ <br/>
                https://www.them.us/story/book-bans-conservative-advocacy-groups<br/>
                https://pen.org/book-bans/pen-america-index-of-school-book-bans-2023-2024/<br/>
                https://pen.org/report/banned-in-the-usa-state-laws-supercharge-book-suppression-in-schools/<br/>
                https://www.thelist.com/1053945/why-the-color-purple-became-a-banned-book/<br/>
                https://upnorthnewswi.com/2025/04/16/banned-book-of-the-month-shine-by-madisons-lauren-myracle/<br/>
                https://www.npr.org/2022/12/21/1143100410/banned-books-author-susan-kuklin-beyond-magenta<br/>
                https://nonprofitquarterly.org/writers-of-banned-books-speak-out/<br/>
                https://www.teenvogue.com/story/banned-books-to-read<br/>
                Wikipedia<br/>
                Goodreads<br/>
                The Banned Books Project<br/>
                Marshall Libraries<br/>
                The New York Times<br/>
                Duck Duck Go AI
             </p>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js"></script>
    <script>
        const containerWidth = 1000;
        const containerHeight = 600;

        // Common tooltip setup
        const tooltip = d3.select("#tooltip");
        
        function showTooltip(event, text) {
            tooltip
                .style("opacity", 1)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 20) + "px")
                .html(text);
        }
        
        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        function jitter(){
            let i = Math.random()*10;
            if (i <= 5) {
                j = -2;
            } else {
                j = 2;
            }
            return Math.random() * j;

        }

        let thisTheme = "";
        let themeCont = "";
        let thisColor = "";
        let overview = false;
        let mature = false;
        let violence = false;
        let race = false;
        let sexuality = false;
        let death = false;
        let drugs = false;
        let religion = false;

        function openTheme(evt, themeName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(themeName).style.display = "block";
        evt.currentTarget.className += " active";

        if (themeName == "Overview") {
            if (!overview){
                thisTheme = "Default";
                themeCont = "#scatterplot";
                renderScatterplot();
                overview = true;
            }
        } else if (themeName == "Sexual"){
            if (!mature){
                thisTheme = "Sexual Content & Profanity";
                themeCont = "#scatterplot-mature";
                thisColor = "#1b9c9e";
                renderScatterplotSpecific();  
                mature = true; 
            }
        } else if (themeName == "Violence") {
            if (!violence){
                thisTheme = "Violence & Abuse";
                themeCont = "#scatterplot-violence";
                thisColor = "#d95f02";
                renderScatterplotSpecific();   
                violence = true; 
            }
        } else if (themeName == "Race") {
            if (!race) {
                thisTheme = "Race/Racism";
                themeCont = "#scatterplot-race";
                thisColor = "#7570b3";
                renderScatterplotSpecific();
                race = true;
            }
        } else if (themeName == "Sexuality") {
            if (!sexuality){
                thisTheme = "Sexuality/Gender";
                themeCont = "#scatterplot-sexuality";
                thisColor = "#e7298a";
                renderScatterplotSpecific();
                sexuality = true;
            }
        } else if (themeName == "Death") {
            if (!death) {
                thisTheme = "Death & Illness";
                themeCont = "#scatterplot-death";
                thisColor = "#66a61e";
                renderScatterplotSpecific();
                death = true;
            }
        } else if (themeName == "Drugs") {
            if (!drugs) {
                thisTheme = "Drugs & Alcohol";
                themeCont = "#scatterplot-drugs";
                thisColor = "#e6ab02";
                renderScatterplotSpecific();
                drugs = true;
            }
        } else if (themeName == "Religion") {
            if (!religion){
                thisTheme = "Religion & Politics";
                themeCont = "#scatterplot-religion";
                thisColor = "#a6761d";
                renderScatterplotSpecific();
                religion = true;
            }
        }
        }

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        // Scatterplots
        function renderScatterplot() {
            const containerWidthScatter = 874;
            const containerHeightScatter = 520;
            const margins = { top: 20, right: 90, bottom: 100, left: 60 };
            const width = containerWidthScatter - margins.left - margins.right;
            const height = containerHeightScatter - margins.top - margins.bottom;

            const svg = d3.select(themeCont)
                .append("svg")
                .attr("width", containerWidthScatter)
                .attr("height", containerHeightScatter)
                .append("g")
                .attr("transform", `translate(${margins.left},${margins.top})`);

            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            d3.csv("bannedBooksThemesUpdated.csv").then(function(data) {
                data.forEach(function(d) {
                    d.Times = +d.Times;
                    d.NumStates = +d.NumStates;
                });

                // scale for x axis
                const x = d3
                    .scaleLinear()
                    .domain([0, d3.max(data.map((d) => d.Times))])
                    .range([0, width]);

                // scale for y axis
                const y = d3
                    .scaleLinear()
                    .domain([
                        0,
                        d3.max(data, (d) => d.NumStates),
                    ])
                    .nice()
                    .range([height, 0]);

                const color = d3.scaleOrdinal()
                    .domain(["Sexual Content & Profanity", "Violence & Abuse", "Race/Racism", "Sexuality/Gender", "Death & Illness", "Drugs & Alcohol", "Religion & Politics"])
                    .range(["#1b9c9e",'#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02','#a6761d']);//d3.schemeSet2

                // adding x axis
                svg.append("g")
                    .attr("class", "axis axis-x")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x).ticks(10))
                    .selectAll("text")
                    .style("font-size", "11pt");

                // adding y axis
                svg.append("g")
                    .attr("class", "axis axis-y")
                    .call(d3.axisLeft(y).ticks(5))
                    .selectAll("text")
                    .style("font-size", "11pt");

                svg.append("text")
                    .attr("class", "axes")
                    .attr("x", width/2)
                    .attr("y", 465)
                    .attr("text-anchor", "middle")
                    .style("font-size", "13pt")
                    .text("Times Banned");

                svg.append("text")
                    .attr("class", "axes")
                    .attr("x", height/-2)
                    .attr("y", -45)
                    .attr("transform", "rotate(-90)")
                    .attr("text-anchor", "middle")
                    .style("font-size", "13pt")
                    .text("Number of States Banned In");

                svg.append("text")
                    .attr("x", 50)
                    .attr("y", height + 80)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://pen.org/book-bans/pen-america-index-of-school-book-bans-2023-2024/'>PEN America</a>");

                    // adding points
                svg.selectAll(".point")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", "point")
                    .attr("cx", d => x(d.Times))
                    .attr("r", 7)
                    .attr("cy", d => y(d.NumStates) + jitter())//Math.random() + Math.random()*2
                    .style("stroke-width", "0px")
                    .style("opacity", "0.6")
                    .attr('fill', d => color(d["Reason"]))
                    .on("mouseover", function(event,d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.Title + " by " + d.Author + "<br/> Themes: " + d.Reason + "<br/>" + d.SecondReason + "<br/>" + d.ThirdReason)
                            .attr("class", "tooltip")
                            .style("text-align", "left")
                            .style("height", "auto")
                            .style("left", (event.pageX + 1) + "px")
                            .style("top", (event.pageY + 10) + "px");
                        })
                    .on("mouseout", function(d) {
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    });

                    const bubbleLegend = d3.legendColor()
                        .shape("circle")
                        .shapeRadius(7)
                        .shapePadding(8)
                        .scale(color)
                        .title("Themes");

                    const legend = svg.append("g")
                        .attr("class", "legend")
                        .attr("transform", `translate(${width-120}, 180)`)
                        .style("font-size", "11pt")
                        .call(bubbleLegend);

            });
        }

        function renderScatterplotSpecific() {
            const containerWidthScatter = 874;
            const containerHeightScatter = 520;
            const margins = { top: 20, right: 90, bottom: 100, left: 60 };
            const width = containerWidthScatter - margins.left - margins.right;
            const height = containerHeightScatter - margins.top - margins.bottom;

            const svg = d3.select(themeCont)
                .append("svg")
                .attr("width", containerWidthScatter)
                .attr("height", containerHeightScatter)
                .append("g")
                .attr("transform", `translate(${margins.left},${margins.top})`);

                var div = d3.select("body").append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                d3.csv("bannedBooksThemesUpdated.csv").then(function(data) {
                    data.forEach(function(d) {
                        d.Times = +d.Times;
                        d.NumStates = +d.NumStates;
                        // Add a property to determine if this book belongs to the current theme
                        d.belongsToTheme = (d.Reason === thisTheme || d.SecondReason === thisTheme || d.ThirdReason === thisTheme);
                    });
                    
                    // Filter data to only include books with this theme
                    const filteredData = data.filter(d => d.belongsToTheme);

                    // scale for x axis
                    const x = d3
                        .scaleLinear()
                        .domain([0, d3.max(data.map((d) => d.Times))])
                        .range([0, width]);

                    // scale for y axis
                    const y = d3
                        .scaleLinear()
                        .domain([
                            0,
                            d3.max(data, (d) => d.NumStates),
                        ])
                        .nice()
                        .range([height, 0]);

                    // adding x axis
                    svg.append("g")
                        .attr("class", "axis axis-x")
                        .attr("transform", `translate(0, ${height})`)
                        .call(d3.axisBottom(x).ticks(10))
                        .selectAll("text")
                        .style("font-size", "11pt");

                    // adding y axis
                    svg.append("g")
                        .attr("class", "axis axis-y")
                        .call(d3.axisLeft(y).ticks(5))
                        .selectAll("text")
                        .style("font-size", "11pt");

                    svg.append("text")
                        .attr("class", "axes")
                        .attr("x", width/2)
                        .attr("y", 485)
                        .attr("text-anchor", "middle")
                        .style("font-size", "13pt")
                        .text("Times Banned");

                    svg.append("text")
                        .attr("class", "axes")
                        .attr("x", height/-2)
                        .attr("y", -45)
                        .attr("transform", "rotate(-90)")
                        .attr("text-anchor", "middle")
                        .style("font-size", "13pt")
                        .text("Number of States Banned In");

                    svg.append("text")
                        .attr("x", 50)
                        .attr("y", height + 80)
                        .attr("text-anchor", "middle")
                        .html("Data Source: <a href='https://pen.org/book-bans/pen-america-index-of-school-book-bans-2023-2024/'>PEN America</a>");

                    // Add count information
                    // svg.append("text")
                    //     .attr("x", width - 100)
                    //     .attr("y", 20)
                    //     .attr("text-anchor", "end")
                    //     .style("font-size", "12pt")
                    //     .text(`Books: ${filteredData.length} of ${data.length}`);

                    // adding points - ONLY for the filtered data
                    svg.selectAll(".point")
                        .data(filteredData)  // Use filtered data
                        .enter()
                        .append("circle")
                        .attr("class", "point")
                        .attr("cx", d => x(d.Times))
                        .attr("r", 7)
                        .attr("cy", d => y(d.NumStates) + jitter())
                        .style("stroke-width", "0px")
                        .style("opacity", "0.8")
                        .attr("fill", thisColor)
                        .on("mouseover", function(event,d) {
                            div.transition()
                                .duration(200)
                                .style("opacity", .9);
                            div.html(d.Title + " by " + d.Author + "<br/> Themes: " + d.Reason + 
                                (d.SecondReason ? "<br/>" + d.SecondReason : "") + 
                                (d.ThirdReason ? "<br/>" + d.ThirdReason : ""))
                                .attr("class", "tooltip")
                                .style("text-align", "left")
                                .style("height", "auto")
                                .style("left", (event.pageX + 15) + "px")
                                .style("top", (event.pageY + 10) + "px");
                            })
                        .on("mouseout", function(d) {
                            div.transition()
                            .duration(500)
                            .style("opacity", 0);
                        });

                    // Simple legend just showing the current theme
                    const legend = svg.append("g")
                        .attr("class", "legend")
                        .attr("transform", `translate(${width - 140}, 300)`);
                        
                    legend.append("circle")
                        .attr("r", 7)
                        .attr("cx", 10)
                        .attr("cy", 5)
                        .attr("fill", thisColor);
                        
                    legend.append("text")
                        .attr("x", 25)
                        .attr("y", 9)
                        .text(thisTheme);
                        
                    legend.append("text")
                        .attr("x", 20)
                        .attr("y", -15)
                        .attr("font-weight", "bold")
                        .text("Theme");
                });
        }

        // Donut Charts
        function renderDonutChart() {
            // const containerWidth = 900;
            // const containerHeight = 600;
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;
            const radius = Math.min(width, height) / 2.5;
            const banner = new Map();

            const svg = d3.select("#donut-chart")
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            d3.csv("where-challenged.csv").then(function(data) {
                data.forEach(function(d) {
                    d.percentage = +d.percentage;
                    banner.set(d.place, d.percentage);
                });
                
                data = banner;

                const color = d3.scaleOrdinal()
                .domain(["Public Libraries", "School Libraries", "Schools", "Higher Education/Other"])
                .range(['#8da0cb','#66c2a5','#fc8d62','#e78ac3']);

                svg.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", `translate(${width-300},${height/2 - 100})`);

                var legend = d3.legendColor()
                    .title("Places")
                    .scale(color)
                    .shapePadding(5);

                svg.select(".legendQuant")
                    .call(legend);

                svg.append("text")
                    .attr("x", 130)//width/2
                    .attr("y", height - 30)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://www.ala.org/bbooks/censorship-numbers'>American Library Association</a>");

                const pie = d3.pie()
                .value(d=>d[1]);//percentage

                // adding donut
                svg.selectAll('donut')
                    .data(pie(data))
                    .join('path')
                    .attr('d', d3.arc()
                        .innerRadius(100)
                        .outerRadius(radius)
                    )
                    .attr('fill', d => color(d.data[0]))//advocates
                    .attr("stroke", "black")
                    .style("stroke-width", "1px")
                    .attr("transform", `translate(${width/2 - 180},${height/2 - 50})`)//;
                    .on("mouseover", function(event,d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.data[0] + ": " + d.data[1] + "%")
                            .attr("class", "tooltip")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY + 10) + "px");
                        })
                    .on("mouseout", function(d) {
                        div.transition()
                        .duration(500)
                        .style("opacity", 0)});
            });
        }

        function renderDonutChart2() {
            // const containerWidth = 900;
            // const containerHeight = 600;
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;
            const radius = Math.min(width, height) / 2.5;
            const banner = new Map();

            const svg = d3.select("#donut-chart2")
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            d3.csv("who-challenges.csv").then(function(data) {
                data.forEach(function(d) {
                    d.percentage = +d.percentage;
                    banner.set(d.advocates, d.percentage);
                });
                //console.log(banner);
                data = banner;
                //console.log(data);
                const color = d3.scaleOrdinal()
                    .domain(["Board/Administration", "Pressure Groups", "Parents", "Elected Officials/Government", "Other", "Patrons", "Librarians/Teachers/Staff"])
                    .range(['#a6cee3','#1f78b4','#b2df8a','#33a02c','#fb9a99','#e31a1c','#fdbf6f']);

                svg.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", `translate(${width-300},${height/2 - 100})`);

                var legend = d3.legendColor()
                    .title("Advocates")
                    .scale(color)
                    .shapePadding(5);

                svg.select(".legendQuant")
                    .call(legend);

                svg.append("text")
                    .attr("x", 130)//width/2
                    .attr("y", height - 30)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://www.ala.org/bbooks/censorship-numbers'>American Library Association</a>");

                const pie = d3.pie()
                .value(d=>d[1]);//percentage

                // adding donut
                svg.selectAll('donut')
                    .data(pie(data))
                    .join('path')
                    .attr('d', d3.arc()
                        .innerRadius(100)
                        .outerRadius(radius)
                    )
                    .attr('fill', d => color(d.data[0]))//advocates
                    .attr("stroke", "black")
                    .style("stroke-width", "1px")
                    .attr("transform", `translate(${width/2 - 180},${height/2 - 50})`)//;
                    .on("mouseover", function(event,d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d.data[0] + ": " + d.data[1] + "%")
                            .attr("class", "tooltip")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY + 10) + "px");
                        })
                    .on("mouseout", function(d) {
                        div.transition()
                        .duration(500)
                        .style("opacity", 0)});
            });
        }

        // Bar Chart
        function renderBarChart() {
            const containerWidth = 900;
            const containerHeight = 600;
            const margins = { top: 20, right: 50, bottom: 100, left: 150 };
            const width = containerWidth - margins.left - margins.right;
            const height = containerHeight - margins.top - margins.bottom - 20;

            const svg = d3.select("#bar-chart")
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margins.left},${margins.top})`);
            
            var div = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            d3.csv("themes.csv").then(function(data) {
                // Convert string values to numbers
            data.forEach(function(d) {
                    d["num-books"] = +d["num-books"];
                    //d["type"] = d.type;
                });
                console.log(data);

                // scale for x axis
                const x = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d["num-books"])])
                    .range([0, width]);

                // scale for y axis
                const y = d3.scaleBand()
                    .domain(data.map(d => d.theme))
                    //.nice()
                    .range([0, height])
                    .padding(0.3);

                const color = d3.scaleOrdinal()
                    .domain(["Violence and/or Sex", "Mental Health", "Identity"])
                    .range(["#6aa7df","#6d32b0","#900000","#f1ab64","#469f36"]);

                svg.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", `translate(${530},${300})`);

                var legend = d3.legendColor()
                    .title("Type of Theme")
                    .scale(color)
                    .shapePadding(5);

                svg.select(".legendQuant")
                    .call(legend);

                // adding x axis
                svg.append("g")
                    .attr("class", "axis axis-x")
                    .attr("transform", `translate(0, ${height})`)
                    .call(d3.axisBottom(x));

                // adding y axis
                svg.append("g")
                    .attr("class", "axis axis-y")
                    .call(d3.axisLeft(y).ticks(5));

                svg.append("text")
                    .attr("class", "axes")
                    .attr("x", width/2)
                    .attr("y", 510)
                    .attr("text-anchor", "middle")
                    .text("Number of Books");

                svg.append("text")
                    .attr("class", "axes")
                    .attr("x", height/-2)
                    .attr("y", -70)
                    .attr("transform", "rotate(-90)")
                    .attr("text-anchor", "middle");

                svg.append("text")
                    .attr("x", -50)
                    .attr("y", height + 50)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://pen.org/report/banned-in-the-usa-state-laws-supercharge-book-suppression-in-schools/'>PEN America</a>");

                // adding bars
                svg.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", 0)
                    .attr("width", d => x(d["num-books"]))
                    .attr("y", d => y(d.theme))
                    .attr("height", y.bandwidth())
                    //.style("fill", "#c71e1d");
                    .attr('fill', d => color(d["type"]))
                    .on("mouseover", function(event,d) {
                        div.transition()
                            .duration(200)
                            .style("opacity", .9);
                        div.html(d["num-books"] + " books")
                            .attr("class", "tooltip")
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY + 10) + "px");
                        })
                    .on("mouseout", function(d) {
                        div.transition()
                        .duration(500)
                        .style("opacity", 0);
                    });;
            
            });
        }

        // Treemap from json data file
        function renderTreemapJSON() {
            const margins = { top: 20, right: 300, bottom: 100, left: 30 };
            const width = containerWidth - margins.left - margins.right;
            const height = containerHeight - margins.top - margins.bottom - 20;

            const svg = d3.select("#treemap")
                .append("svg")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .append("g")
                .attr("transform", `translate(${margins.left},${margins.top})`);

            // Color scale for categories using ColorBrewer scheme
            const color = d3.scaleOrdinal()
                .domain(["Sexual Content & Profanity", "Violence & Abuse", "Race/Racism", "Sexuality/Gender", "Death & Illness"])
                .range(["#1b9c9e",'#d95f02','#7570b3','#e7298a','#66a61e']);

            d3.json("treemapThemeData.json").then(function(data) {
                //Hierarchical data processing
                const root = d3.hierarchy(data)
                    .sum(d => d.value)
                    .sort((a, b) => b.value - a.value);
                // var root = d3.hierarchy(data).sum(function(d){ return d.value})

                console.log(root);

                // Create treemap layout
                d3.treemap()
                    .size([width, height])
                    .padding(2)
                    (root);

                // Add rectangles
                svg.selectAll("rect")
                    .data(root.leaves())
                    .enter()
                    .append("rect")
                    .attr("class", "node")
                    .attr("x", d => d.x0)
                    .attr("y", d => d.y0)
                    .attr("width", d => d.x1 - d.x0)
                    .attr("height", d => d.y1 - d.y0)
                    .style("fill", d => color(d.parent.data.name))
                    .on("mouseover", (event, d) => {
                        showTooltip(event, `${d.parent.data.name}: ${d.data.name}<br>${d.data.value} books`);
                    })
                    .on("mouseout", hideTooltip);

                // Add text labels
                svg.selectAll("text")
                    .data(root.leaves())
                    .enter()
                    .append("text")
                    .attr("x", d => d.x0 + 5)
                    .attr("y", d => d.y0 + 15)
                    .text(d => d.data.name)
                    .attr("font-size", "12px")
                    .attr("fill", "white")
                    .each(function(d) {
                        const node = this;
                        const textWidth = node.getComputedTextLength();
                        const boxWidth = d.x1 - d.x0;
                        
                        // Only show text if it fits
                        if (textWidth > boxWidth - 10) {
                            d3.select(this).style("opacity", 0);
                        }
                    });

                // Create legend using d3-legend
                const treeLegend = d3.legendColor()
                    .shape("rect")
                    .shapeWidth(16)
                    .shapeHeight(16)
                    .shapePadding(10)
                    .scale(color)
                    .title("Categories");

                const legend = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width + 20}, 20)`)
                    .style("inline-size", "60px")
                    .style("overflow-wrap", "break-all")
                    .call(treeLegend);

                svg.append("text")
                    .attr("x", 100)
                    .attr("y", height + 40)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://pen.org/report/banned-in-the-usa-state-laws-supercharge-book-suppression-in-schools/#heading-5'>PEN America</a>");
            });
            
        }

        function renderCartogram() {

        // Set up dimensions
        const margin = { top: 20, right: 20, bottom: 20, left: 20 };
        const width = containerWidth - margin.left - margin.right;
        const height = containerHeight - margin.top - margin.bottom;

        // Calculate the size of each square
        const squareSize = 50;
        const padding = 5;

        // Create SVG
        const svg = d3.select("#cartogram-chart")
            .append("svg")
            .attr("width", containerWidth)
            .attr("height", containerHeight)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create a tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            d3.csv("stateCodeBookBans.csv").then(function(data) {
                data.forEach(function(d) {
                    d.Bans = +d.Bans;
                    d.row = +d.row;
                    d.col = +d.col + 1;
                });

                const banColors = d3.scaleThreshold()
                    .domain([30, 60, 100, 300, 600])
                    .range(['#feebe2','#fcc5c0','#fa9fb5','#f768a1','#c51b8a','#7a0177']);

                svg.append("g")
                    .attr("class", "legendQuant")
                    .attr("transform", "translate(750,300)");

                var legend = d3.legendColor()
                    .labelFormat(d3.format(".0f"))
                    .title("Number of Challenges")
                    .shapeWidth(50)
                    .scale(banColors);

                svg.select(".legendQuant")
                    .call(legend);

                // Create squares for each state
                const states = svg.selectAll(".state")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "state")
                    .attr("x", d => d.col * (squareSize + padding))
                    .attr("y", d => d.row * (squareSize + padding))
                    .attr("width", squareSize)
                    .attr("height", squareSize)
                    .attr("fill", d => banColors([d.Bans]))
                    .on("mouseover", function(event, d) {
                        d3.select(this)
                        .transition()
                        .duration(100)
                        .attr("stroke", "black")
                        .attr("stroke-width", 2);
                        
                        tooltip.transition()
                        .duration(100)
                        .style("opacity", 0.9);
                        
                        tooltip.html(`${d.name} (${d.code}): ${d.Bans}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select(this)
                        .transition()
                        .duration(100)
                        .attr("stroke", "white")
                        .attr("stroke-width", 1);
                        
                        tooltip.transition()
                        .duration(200)
                        .style("opacity", 0);
                    });

                // Add state labels
                svg.selectAll(".state-label")
                    .data(data)
                    .enter()
                    .append("text")
                    .attr("class", "state-label")
                    .attr("x", d => d.col * (squareSize + padding) + squareSize/2)
                    .attr("y", d => d.row * (squareSize + padding) + squareSize/2 + 5)
                    .attr("text-anchor", "middle")
                    .attr("font-size", "12px")
                    .attr("font-weight", "bold")
                    .attr("fill", "white")
                    .text(d => d.code);

            });

            svg.append("text")
                    .attr("x", 100)
                    .attr("y", 520)
                    .attr("text-anchor", "middle")
                    .html("Data Source: <a href='https://pen.org/book-bans/pen-america-index-of-school-book-bans-2023-2024/'>PEN America</a>");
    }

        // Render all charts
        renderCartogram();
        renderDonutChart();
        renderDonutChart2();
        renderTreemapJSON();
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9350595ed95e15d8","serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.4.0-1-g37f21b1","token":"cefab20fd71347d6a38acf95504d2fe5"}' crossorigin="anonymous"></script>
</body>
</html>